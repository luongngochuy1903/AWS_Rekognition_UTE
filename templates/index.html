<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>AWS Rekognition Demo</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h2 { margin-top: 0; }
        .container { display: flex; gap: 20px; }
        .column { flex: 1; border: 1px solid #ccc; padding: 20px; border-radius: 8px; box-shadow: 0 0 5px #aaa; }
        .column img { max-width: 100%; max-height: 200px; display: block; margin-bottom: 10px; }
        button { display: block; margin: 10px 0; padding: 10px 15px; font-size: 14px; cursor: pointer; }
        input[type="file"] { margin-bottom: 10px; }
        pre { background: #f7f7f7; padding: 10px; border-radius: 5px; max-height: 400px; overflow: auto; }
    </style>
</head>
<body>

<h1>AWS Rekognition Demo</h1>
<div class="container">

    <!-- Cột 1: Chọn ảnh & preview -->
    <div class="column">
        <h2>Chọn ảnh</h2>
        <input type="file" id="image" accept="image/*">
        <img id="preview" src="" alt="Preview ảnh">
        <input type="file" id="image_target" accept="image/*">
        <img id="preview_target" src="" alt="Preview ảnh đích">
        <input type="text" id="face_id" placeholder="Nhập face ID:">
        
        
    </div>

    <!-- Cột 2: Các API buttons -->
    <div class="column">
        <h2>Gọi API</h2>
        <button id="detect-labels">Detect Labels</button>
        <button id="recognise">Recognise Faces</button>
        <button id="compare-faces">Compare Faces</button>
        <button id="search-face">Search Face</button>
        <button id="search-user">Search User</button>
        <button id="search-user-by-image">Search user by image</button>
        <h3>Kết quả</h3>
        <pre id="api-result">Chưa có kết quả</pre>
    </div>

    <!-- Cột 3: Upload & Collection -->
    <div class="column">
        <h2>Upload & Collection</h2>
        <input type="file" id="image_upload" accept="image/*">
        <img id="upload-preview" src="" alt="Preview upload">
        <input type="text" id="name" placeholder="Nhập tên">
        <input type="number" id="age" placeholder="Nhập tuổi">
        <button id="upload-s3">Upload lên S3</button>
        <h3>Kết quả</h3>
        <pre id="upload-result">Chưa có kết quả</pre>
    </div>

</div>

<script>
    // ==== Cột 1 ====
    let selectedFile = null;
    let targetFile = null;
    document.getElementById("image").addEventListener("change", (e) => {
        selectedFile = e.target.files[0];
        if (selectedFile) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                document.getElementById("preview").src = evt.target.result;
            };
            reader.readAsDataURL(selectedFile);
        }
    });

    document.getElementById("image_target").addEventListener("change", (e) => {
        targetFile = e.target.files[0];
        if (targetFile) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                document.getElementById("preview_target").src = evt.target.result;
            };
            reader.readAsDataURL(targetFile);
        }
    });

    async function sendFile(endpoint, extraData = {}) {
        if (!selectedFile) { 
            alert("Hãy chọn ảnh trước!"); 
            return; 
        }
        const formData = new FormData();
        formData.append("image", selectedFile);
        for (const [k, v] of Object.entries(extraData)) formData.append(k, v);

        const response = await fetch(endpoint, { method: "POST", body: formData });
        return await response.json();
    }

    // ====== Các nút API ======
    document.getElementById("detect-labels").addEventListener("click", async () => {
        const result = await sendFile("/detect");
        document.getElementById("api-result").textContent = JSON.stringify(result, null, 2);
    });

    document.getElementById("recognise").addEventListener("click", async () => {
        const result = await sendFile("/recognise"); // SearchFacesByImage
        document.getElementById("api-result").textContent = JSON.stringify(result, null, 2);
    });

    document.getElementById("compare-faces").addEventListener("click", async () => {
        if (!selectedFile ) {
            alert("Vui lòng chọn ảnh nguồn so sánh!");
            return;
        }
        if (!targetFile) {
            alert("Vui lòng chọn ảnh đích để so sánh!");
            return;
        }

        const formData = new FormData();
        formData.append("image", selectedFile);
        formData.append("image_target", targetFile);

        const res = await fetch("/compare", { method: "POST", body: formData });
        const result = await res.json();

        document.getElementById("api-result").textContent = JSON.stringify(result, null, 2);
    });

    // ====== SearchFaces (theo FaceId) ======
    document.getElementById("search-face").addEventListener("click", async () => {
        const faceId = document.getElementById("face_id").value.trim();
        if (!faceId) { alert("Hãy nhập FaceId trước!"); return; }

        const formData = new FormData();
        formData.append("face_id", faceId);

        const res = await fetch("/search_face", { method: "POST", body: formData });
        const result = await res.json();
        document.getElementById("api-result").textContent = JSON.stringify(result, null, 2);
    });

    // ====== SearchUsers (theo FaceId) ======
    document.getElementById("search-user").addEventListener("click", async () => {
        const faceId = document.getElementById("face_id").value.trim();
        if (!faceId) { alert("Hãy nhập FaceId trước!"); return; }

        const formData = new FormData();
        formData.append("face_id", faceId);

        const res = await fetch("/search_users", { method: "POST", body: formData });
        const result = await res.json();
        document.getElementById("api-result").textContent = JSON.stringify(result, null, 2);
    });

    // ====== SearchUsersByImage (ảnh mới) ======
    document.getElementById("search-user-by-image").addEventListener("click", async () => {
        const result = await sendFile("/search_users_by_image");
        document.getElementById("api-result").textContent = JSON.stringify(result, null, 2);
    });

    // ==== Cột 3 ====
    let selectedUploadFile = null;
    document.getElementById("image_upload").addEventListener("change", (e) => {
        selectedUploadFile = e.target.files[0];
        if (selectedUploadFile) {
            const reader = new FileReader();
            reader.onload = (evt) => {
                document.getElementById("upload-preview").src = evt.target.result;
            };
            reader.readAsDataURL(selectedUploadFile);
        }
    });

    async function sendUploadFile(endpoint) {
        if (!selectedUploadFile) {
            alert("Hãy chọn ảnh trước!");
            return;
        }
        const name = document.getElementById("name").value.trim();
        const age = document.getElementById("age").value.trim();

        const formData = new FormData();
        formData.append("image_upload", selectedUploadFile);
        formData.append("name", name);
        formData.append("age", age);

        const response = await fetch(endpoint, { method: "POST", body: formData });
        return await response.json();
    }

    document.getElementById("upload-s3").addEventListener("click", async () => {
        const result = await sendUploadFile("/upload");
        document.getElementById("upload-result").textContent = JSON.stringify(result, null, 2);
    });
</script>

</body>
</html>
